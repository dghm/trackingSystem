//- è²¨ä»¶åˆ—è¡¨çµ„ä»¶ï¼ˆç”¨æ–¼ Dashboardï¼‰
style.
  .list-container {
    max-width: 100%;
    margin: 0;
    padding: 0;
  }
  .list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
  }
  .list-title-section {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }
  .list-title {
    font-size: 2rem;
    font-weight: 700;
    color: #333;
    margin: 0;
  }
  .list-filter-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .list-filter-btn {
    padding: 6px 16px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: #333;
    font-size: 14px;
    font-weight: 400;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.2);
    white-space: nowrap;
  }
  .list-filter-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px 0 rgba(31, 38, 135, 0.3);
  }
  .list-filter-btn.active {
    background: rgba(13, 35, 160, 0.2);
    border-color: rgba(13, 35, 160, 0.4);
    color: #0D23A0;
    font-weight: 600;
  }
  .list-filter-custom-group {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .filter-date-text {
    font-size: 14px;
    color: #666;
    font-weight: 400;
    white-space: nowrap;
  }
  .list-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
  .btn-add {
    padding: 10px 20px;
    background: #4caf50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
  }
  .btn-add:hover {
    background: #45a049;
  }
  .btn-refresh {
    padding: 10px 20px;
    background: #0D23A0;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
  }
  .btn-refresh:hover {
    background: #0a1b7a;
  }
  .btn-refresh:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  .list-stats {
    color: #666;
    font-size: 14px;
  }
  .list-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
  }
  .list-table thead {
    background: #f5f5f5;
  }
  .list-table th {
    padding: 15px;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #ddd;
    font-size: 14px;
  }
  .list-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    font-size: 14px;
    color: #333;
  }
  .list-table tbody tr:hover {
    background: #f9f9f9;
  }
  .list-table tbody tr:last-child td {
    border-bottom: none;
  }
  .pagination {
    margin-top: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
  }
  .pagination-info {
    font-size: 14px;
    color: #555;
  }
  .pagination-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .pagination button {
    padding: 8px 16px;
    border: 1px solid #ccc;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }
  .pagination button:hover:not(:disabled) {
    background: #f5f5f5;
  }
  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    color: #ffffff;
  }
  .status-step-1 {
    background: #446FA0;
  }
  .status-step-2 {
    background: #3B65A1;
  }
  .status-step-3 {
    background: #3057A2;
  }
  .status-step-4 {
    background: #264CA3;
  }
  .status-step-5 {
    background: #1B3EA5;
  }
  .status-step-6 {
    background: #1031A6;
  }
  .status-step-7 {
    background: #0524A7;
  }
  .status-processing {
    background: #264CA3;
  }
  .status-completed {
    background: #0524A7;
  }
  .status-pending {
    background: #446FA0;
  }
  .btn-checkbox-info, .btn-edit {
    background: transparent;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    color: #666;
    display: inline-flex;
    align-items: center;
    transition: all 0.2s;
  }
  .btn-checkbox-info:hover, .btn-edit:hover {
    background: #f5f5f5;
    border-color: #0D23A0;
    color: #0D23A0;
  }
  .lightbox-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s;
  }
  .lightbox-overlay.fade-out {
    animation: fadeOut 0.3s;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }
  .lightbox-content {
    background: white;
    border-radius: 8px;
    max-width: 640px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s;
  }
  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  .lightbox-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #eee;
  }
  .lightbox-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  }
  .lightbox-close {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #999;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
  }
  .lightbox-close:hover {
    background: #f5f5f5;
    color: #333;
  }
  .lightbox-body {
    padding: 20px;
  }
  .info-section, .checkbox-section {
    margin-bottom: 24px;
  }
  .info-section:last-child, .checkbox-section:last-child {
    margin-bottom: 0;
  }
  .info-section h4, .checkbox-section h4 {
    margin: 0 0 16px 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }
  .info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .info-label {
    font-size: 12px;
    color: #666;
  }
  .info-value {
    font-size: 14px;
    color: #333;
    font-weight: 500;
  }
  .checkbox-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }
  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid #ddd;
    transition: all 0.2s;
    user-select: none;
  }
  .checkbox-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .checkbox-item.checked {
    background: #e8f5e9;
    border-color: #4caf50;
  }
  .checkbox-item.unchecked {
    background: #f5f5f5;
    border-color: #ddd;
  }
  .btn-save:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  .checkbox-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    font-weight: bold;
    font-size: 14px;
  }
  .checkbox-item.checked .checkbox-icon {
    background: #4caf50;
    color: white;
  }
  .checkbox-item.unchecked .checkbox-icon {
    background: #ddd;
    color: #999;
  }
  .checkbox-label {
    font-size: 14px;
    font-weight: 500;
    color: #333;
  }
  .checkbox-summary {
    margin-top: 16px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 6px;
    font-size: 14px;
    color: #666;
  }
  .edit-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    font-family: inherit;
    transition: border-color 0.2s;
  }
  .edit-input:focus {
    outline: none;
    border-color: #0D23A0;
    box-shadow: 0 0 0 2px rgba(13, 35, 160, 0.1);
  }
  .edit-input[type="number"] {
    -moz-appearance: textfield;
  }
  .edit-input[type="number"]::-webkit-inner-spin-button,
  .edit-input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .loading {
    text-align: center;
    padding: 40px;
    color: #666;
  }
  .error {
    text-align: center;
    padding: 40px;
    color: #dc3545;
    background: #f8d7da;
    border-radius: 8px;
    margin: 20px 0;
  }
  .empty {
    text-align: center;
    padding: 40px;
    color: #666;
  }
  .link-tracking {
    color: #0D23A0;
    text-decoration: none;
    font-weight: 500;
  }
  .link-tracking:hover {
    text-decoration: underline;
  }
  .stats-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 8px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 12px 0 rgba(31, 38, 135, 0.37);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
    border-color: rgba(255, 255, 255, 0.3);
  }
  .stat-card__label {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
    font-weight: 400;
  }
  .stat-card__value {
    font-size: 32px;
    font-weight: 600;
    color: #333;
    line-height: 1;
  }
  .stat-card--with-chart {
    display: flex;
    flex-direction: row;
    gap: 20px;
  }
  .stat-card__value-container {
    flex: 1;
  }
  .stat-card__chart-container {
    flex-shrink: 0;
  }
  .stat-card__pie-chart {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .stat-card__pie-chart::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60px;
    height: 60px;
    background: #ffffff;
    border-radius: 50%;
    z-index: 1;
  }
  .stat-card__pie-percentage {
    position: relative;
    z-index: 2;
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }
  @media (max-width: 768px) {
    .list-table {
      font-size: 12px;
    }
    .list-table th,
    .list-table td {
      padding: 8px;
    }
    .list-header {
      flex-direction: column;
      align-items: flex-start;
    }
    .stats-cards {
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .stat-card {
      padding: 16px;
    }
    .stat-card__value {
      font-size: 24px;
    }
  }

.list-container
  .list-header
    .list-title-section
      h1.list-title è²¨ä»¶è¿½è¹¤åˆ—è¡¨
      .list-filter-buttons
        button.list-filter-btn.active(data-filter="week") æœ¬é€±
        button.list-filter-btn(data-filter="month") æœ¬æœˆ
        .list-filter-custom-group
          button.list-filter-btn(data-filter="custom") è‡ªå®š
          span.filter-date-text æ—¥æœŸï¼š2025/11/17 ~ 2025/11/23
    .list-controls
      .list-stats#listStats è¼‰å…¥ä¸­...
      button.btn-add#addBtn æ–°å¢è²¨ä»¶
      button.btn-refresh#refreshBtn é‡æ–°æ•´ç†

  .stats-cards#statsCards
    .stat-card
      .stat-card__label å·²å®Œæˆä»¶æ•¸
      .stat-card__value#statCompleted 0
    .stat-card.stat-card--with-chart
      .stat-card__value-container
        .stat-card__label è™•ç†ä¸­
        .stat-card__value#statProcessing 0
      .stat-card__chart-container
        .stat-card__pie-chart#statProcessingChart
          .stat-card__pie-percentage#statProcessingPercent 0%
    .stat-card
      .stat-card__label åœ‹éš›é‹è¼¸
      .stat-card__value#statInternational 0
    .stat-card
      .stat-card__label åœ‹å…§é‹è¼¸
      .stat-card__value#statDomestic 0

  #listContent
    .loading æ­£åœ¨è¼‰å…¥è³‡æ–™...

script.
  // ä½¿ç”¨ window.CONFIG ä¸­çš„ API_BASE_URLï¼Œé¿å…é‡è¤‡å®£å‘Š
  const apiBaseUrl = window.CONFIG?.API_BASE_URL || '/.netlify/functions';
  const listContent = document.getElementById('listContent');
  const refreshBtn = document.getElementById('refreshBtn');
  const listStats = document.getElementById('listStats');
  const filterButtons = document.querySelectorAll('.list-filter-btn');
  
  // è™•ç†ç¯©é¸æŒ‰éˆ•é»æ“Š
  filterButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
      filterButtons.forEach(b => b.classList.remove('active'));
      // æ·»åŠ ç•¶å‰æŒ‰éˆ•çš„ active ç‹€æ…‹
      this.classList.add('active');
      
      const filter = this.getAttribute('data-filter');
      console.log('ç¯©é¸é¸é …:', filter);
      
      // TODO: æ ¹æ“šç¯©é¸æ¢ä»¶éæ¿¾è³‡æ–™
      // ç›®å‰å…ˆé‡æ–°è¼‰å…¥è³‡æ–™
      fetchShipmentsList(true);
    });
  });

  async function fetchShipmentsList(forceRefresh = false) {
    try {
      listContent.innerHTML = '<div class="loading">æ­£åœ¨è¼‰å…¥è³‡æ–™...</div>';
      refreshBtn.disabled = true;
      listStats.textContent = 'è¼‰å…¥ä¸­...';

      // ä½¿ç”¨ /api/list ç«¯é»ï¼Œå¼·åˆ¶é‡æ–°è¼‰å…¥æ™‚æ·»åŠ æ™‚é–“æˆ³é¿å…å¿«å–
      const apiUrl = forceRefresh 
        ? `/api/list?t=${Date.now()}`
        : '/api/list';
      console.log('ğŸ” è«‹æ±‚åˆ—è¡¨è³‡æ–™:', apiUrl, forceRefresh ? '(å¼·åˆ¶é‡æ–°è¼‰å…¥)' : '');
      
      // æ·»åŠ è¶…æ™‚æ§åˆ¶
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ™‚
      
      const startTime = Date.now();
      const response = await fetch(apiUrl, {
        signal: controller.signal,
        headers: {
          'Content-Type': 'application/json',
        },
        cache: forceRefresh ? 'no-cache' : 'default', // å¼·åˆ¶é‡æ–°è¼‰å…¥æ™‚ä¸ä½¿ç”¨å¿«å–
      });
      
      clearTimeout(timeoutId);
      const loadTime = ((Date.now() - startTime) / 1000).toFixed(2);
      console.log(`â±ï¸ è¼‰å…¥æ™‚é–“: ${loadTime} ç§’`);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('âŒ API å›æ‡‰éŒ¯èª¤:', response.status, errorText);
        let errorData;
        try {
          errorData = JSON.parse(errorText);
        } catch (e) {
          errorData = { message: `HTTP ${response.status}: ${response.statusText}` };
        }
        throw new Error(errorData.message || errorData.error || 'è¼‰å…¥å¤±æ•—');
      }

      const result = await response.json();
      console.log('âœ… API å›æ‡‰:', result);

      if (!result.success) {
        throw new Error(result.message || result.error || 'è¼‰å…¥å¤±æ•—');
      }

      const shipments = result.data || [];
      console.log(`ğŸ“¦ æ”¶åˆ° ${shipments.length} ç­†è¨˜éŒ„`);
      
      if (shipments.length > 0) {
        console.log('ğŸ“‹ ç¬¬ä¸€ç­†è¨˜éŒ„ç¯„ä¾‹:', shipments[0]);
        if (shipments[0].checkboxFields) {
          console.log('ğŸ“‹ ç¬¬ä¸€ç­†è¨˜éŒ„çš„ checkbox ç‹€æ…‹:', shipments[0].checkboxFields);
        }
      }
      
      // æ›´æ–° currentShipmentsï¼ˆç¢ºä¿ä½¿ç”¨æœ€æ–°çš„è³‡æ–™ï¼‰
      currentShipments = shipments.map(s => ({ ...s })); // æ·±æ‹·è²ï¼Œç¢ºä¿è³‡æ–™ç¨ç«‹
      
      // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
      updateStatistics(shipments);
      
      renderList(shipments);
      listStats.textContent = `å…± ${shipments.length} ç­†è¨˜éŒ„ (è¼‰å…¥æ™‚é–“: ${loadTime}ç§’)`;
    } catch (error) {
      console.error('âŒ è¼‰å…¥åˆ—è¡¨å¤±æ•—:', error);
      let errorMessage = 'è¼‰å…¥å¤±æ•—';
      
      if (error.name === 'AbortError') {
        errorMessage = 'è«‹æ±‚è¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦';
      } else if (error.message) {
        errorMessage = error.message;
      }
      
      listContent.innerHTML = `
        <div class="error">
          <p><strong>${errorMessage}</strong></p>
          <p style="margin-top: 10px; font-size: 12px;">
            è«‹ç¢ºèªï¼š<br>
            1. API ç«¯é»æ˜¯å¦æ­£ç¢ºè¨­å®š<br>
            2. Airtable ç’°å¢ƒè®Šæ•¸æ˜¯å¦æ­£ç¢º<br>
            3. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸
          </p>
          <button onclick="fetchShipmentsList()" style="margin-top: 15px; padding: 8px 16px; background: #0D23A0; color: white; border: none; border-radius: 4px; cursor: pointer;">
            é‡æ–°è¼‰å…¥
          </button>
        </div>
      `;
      listStats.textContent = 'è¼‰å…¥å¤±æ•—';
    } finally {
      refreshBtn.disabled = false;
    }
  }

  // æ›´æ–°çµ±è¨ˆå¡ç‰‡
  function updateStatistics(shipments) {
    const totalCount = shipments ? shipments.length : 0;
    
    if (!shipments || shipments.length === 0) {
      document.getElementById('statProcessing').textContent = '0';
      document.getElementById('statInternational').textContent = '0';
      document.getElementById('statDomestic').textContent = '0';
      document.getElementById('statCompleted').textContent = '0';
      updateProcessingChart(0, 0, 0);
      return;
    }

    // 1. è™•ç†ä¸­ï¼šçµ±è¨ˆ status éç‚º"è²¨ä»¶å·²é€é”"çš„å€‹æ•¸
    // ä½¿ç”¨ latestTimelineTitle ä¾†åˆ¤æ–·ï¼Œå¦‚æœåŒ…å«"è²¨ä»¶å·²é€é”"å‰‡ä¸ç®—è™•ç†ä¸­
    const processingCount = shipments.filter(shipment => {
      const statusText = formatStatus(shipment.status, shipment.latestTimelineTitle);
      return !statusText.includes('è²¨ä»¶å·²é€é”') && !statusText.includes('å·²é€é”');
    }).length;

    // 2. åœ‹éš›é‹è¼¸ï¼šçµ±è¨ˆ Transport Type ç‚º"Import/Export/Cross"çš„å€‹æ•¸
    const internationalCount = shipments.filter(shipment => {
      const transportType = (shipment.transportType || '').toLowerCase().trim();
      return transportType.includes('import') || 
             transportType.includes('export') || 
             transportType.includes('cross') ||
             transportType === 'imex' ||
             transportType.includes('import/export') ||
             transportType.includes('import/export/cross');
    }).length;

    // 3. åœ‹å…§é‹è¼¸ï¼šçµ±è¨ˆ Transport Type ç‚º"Domestic"çš„å€‹æ•¸
    const domesticCount = shipments.filter(shipment => {
      const transportType = (shipment.transportType || '').toLowerCase();
      return transportType === 'domestic';
    }).length;

    // 4. å·²å®Œæˆä»¶æ•¸ï¼šçµ±è¨ˆæ‰€æœ‰ç‹€æ…‹ç‚º"è²¨ä»¶å·²é€é”"çš„å€‹æ•¸
    const completedCount = shipments.filter(shipment => {
      const statusText = formatStatus(shipment.status, shipment.latestTimelineTitle);
      return statusText.includes('è²¨ä»¶å·²é€é”') || statusText.includes('å·²é€é”');
    }).length;

    // æ›´æ–°å¡ç‰‡æ•¸å€¼
    document.getElementById('statProcessing').textContent = processingCount;
    document.getElementById('statInternational').textContent = internationalCount;
    document.getElementById('statDomestic').textContent = domesticCount;
    document.getElementById('statCompleted').textContent = completedCount;

    // æ›´æ–°è™•ç†ä¸­å¡ç‰‡çš„ Pie Chartï¼ˆè™•ç†ä¸­ vs å·²å®Œæˆï¼‰
    updateProcessingChart(processingCount, completedCount, totalCount);
  }

  // æ›´æ–°è™•ç†ä¸­å¡ç‰‡çš„ Pie Chart
  function updateProcessingChart(processingCount, completedCount, totalCount) {
    if (!totalCount || totalCount === 0) {
      document.getElementById('statProcessingChart').style.background = 'conic-gradient(#e5e7eb 0% 100%)';
      document.getElementById('statProcessingPercent').textContent = '0%';
      return;
    }

    // è¨ˆç®—ç™¾åˆ†æ¯”
    const processingPercent = (processingCount / totalCount) * 100;

    // æ›´æ–° Pie Chartï¼ˆä½¿ç”¨ conic-gradientï¼‰
    const processingDeg = (processingPercent / 100) * 360;
    const chartElement = document.getElementById('statProcessingChart');
    chartElement.style.background = `conic-gradient(
      #0D23A0 0deg ${processingDeg}deg,
      #e5e7eb ${processingDeg}deg 360deg
    )`;

    // æ›´æ–°ç™¾åˆ†æ¯”æ–‡å­—ï¼ˆä¿ç•™ä¸€ä½å°æ•¸ï¼Œé¡¯ç¤ºåœ¨ Pie Chart ä¸­é–“ï¼‰
    document.getElementById('statProcessingPercent').textContent = processingPercent.toFixed(1) + '%';
  }

  function renderList(shipments) {
    if (shipments.length === 0) {
      listContent.innerHTML = `
        <div class="empty">
          <p>ç›®å‰æ²’æœ‰è²¨ä»¶è¨˜éŒ„</p>
          <p style="margin-top: 10px; font-size: 12px; color: #999;">
            è«‹ç¢ºèª Airtable è³‡æ–™åº«ä¸­æ˜¯å¦æœ‰è³‡æ–™
          </p>
        </div>
      `;
      return;
    }

    // åˆ†é è¨­å®š
    const itemsPerPage = 10;
    const totalRecords = shipments.length;
    const totalPages = Math.ceil(totalRecords / itemsPerPage);
    let currentPage = 1;

    function getPageShipments(page) {
      const startIndex = (page - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      return shipments.slice(startIndex, endIndex);
    }

    function renderPage(page) {
      currentPage = page;
      const pageShipments = getPageShipments(page);
      const startIndex = (page - 1) * itemsPerPage;

      const tableHTML = `
        <table class="list-table">
          <thead>
            <tr>
              <th>åºè™Ÿ</th>
              <th>è¨‚å–®ç·¨è™Ÿ</th>
              <th>è¿½è¹¤è™Ÿç¢¼</th>
              <th>ç‹€æ…‹</th>
              <th>èµ·é‹åœ° â†’ ç›®çš„åœ°</th>
              <th>åŒ…è£¹æ•¸é‡</th>
              <th>é‡é‡</th>
              <th>é è¨ˆåˆ°é”</th>
              <th>æœ€å¾Œæ›´æ–°</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${pageShipments.map((shipment, index) => {
              // ç¢ºä¿è³‡æ–™å­˜åœ¨æ‰é¡¯ç¤ºé€£çµ
              const hasData = shipment.orderNo && shipment.trackingNo;
              const detailLink = hasData 
                ? `<a href="./index.html?orderNo=${encodeURIComponent(shipment.orderNo)}&trackingNo=${encodeURIComponent(shipment.trackingNo)}" 
                       class="link-tracking" 
                       target="_blank">
                      æŸ¥çœ‹è©³æƒ…
                    </a>`
                : '<span style="color: #999;">â€”</span>';
              
              // æª¢æŸ¥æ˜¯å¦æœ‰ checkbox æ¬„ä½è³‡æ–™ï¼ˆå³ä½¿æ²’æœ‰å‹¾é¸ä¹Ÿé¡¯ç¤ºæŒ‰éˆ•ï¼Œæ–¹ä¾¿æŸ¥çœ‹å’Œç·¨è¼¯ï¼‰
              const checkboxFields = shipment.checkboxFields || {};
              const hasCheckboxFields = Object.keys(checkboxFields).length > 0;
              const checkboxButton = hasCheckboxFields 
                ? `<button class="btn-checkbox-info" data-index="${startIndex + index}" title="æŸ¥çœ‹/ç·¨è¼¯ç‹€æ…‹æ¨™è¨˜">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M8 4V8M8 12H8.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                  </button>`
                : '';
              
              // ç·¨è¼¯æŒ‰éˆ•
              const editButton = `<button class="btn-edit" data-index="${startIndex + index}" title="ç·¨è¼¯è²¨ä»¶è³‡æ–™">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11.333 2.667a2.667 2.667 0 0 1 3.774 3.774l-8 8a2.667 2.667 0 0 1-1.886.78H2.667a1.333 1.333 0 0 1-1.334-1.333v-2.553a2.667 2.667 0 0 1 .78-1.886l8-8z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9.333 4.667l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>`;
              
              const sequenceNumber = startIndex + index + 1;

              return `
              <tr>
                <td>${sequenceNumber}</td>
                <td>${escapeHtml(shipment.orderNo) || 'â€”'}</td>
                <td>${escapeHtml(shipment.trackingNo) || 'â€”'}</td>
                <td>
                  ${(() => {
                    const statusText = formatStatus(shipment.status, shipment.latestTimelineTitle);
                    const statusClass = getStatusClassFromText(statusText);
                    return `<span class="status-badge ${statusClass}">${escapeHtml(statusText)}</span>`;
                  })()}
                </td>
                <td>${escapeHtml(shipment.originDestination) || 'â€”'}</td>
                <td>${escapeHtml(shipment.packageCount) || 'â€”'}</td>
                <td>${escapeHtml(shipment.weight) || 'â€”'}</td>
                <td>${formatDate(shipment.eta) || 'â€”'}</td>
                <td>${formatDate(shipment.lastUpdate) || 'â€”'}</td>
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    ${detailLink}
                    ${checkboxButton}
                    ${editButton}
                  </div>
                </td>
              </tr>
            `;
            }).join('')}
          </tbody>
        </table>
      `;

      const paginationHTML = `
        <div class="pagination">
          <div class="pagination-info">
            ç¬¬ ${currentPage} / ${totalPages} é ï¼Œé¡¯ç¤º ${pageShipments.length} ç­†ï¼Œå…± ${totalRecords} ç­†
          </div>
          <div class="pagination-controls">
            <button class="pagination-btn" data-action="prev" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é </button>
            <button class="pagination-btn" data-action="next" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é </button>
          </div>
        </div>
      `;

      listContent.innerHTML = tableHTML + paginationHTML;

      // ç¶å®šåˆ†é æŒ‰éˆ•äº‹ä»¶
      const prevBtn = listContent.querySelector('[data-action="prev"]');
      const nextBtn = listContent.querySelector('[data-action="next"]');
      
      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          if (currentPage > 1) {
            renderPage(currentPage - 1);
          }
        });
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          if (currentPage < totalPages) {
            renderPage(currentPage + 1);
          }
        });
      }
    }

    // åˆå§‹æ¸²æŸ“ç¬¬ä¸€é 
    renderPage(1);
  }

  // é˜²æ­¢ XSS æ”»æ“Š
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function getStatusClass(status) {
    if (!status) return 'pending';
    const lowerStatus = status.toLowerCase();
    if (lowerStatus.includes('processing') || lowerStatus.includes('transit')) {
      return 'processing';
    }
    if (lowerStatus.includes('completed') || lowerStatus.includes('delivered')) {
      return 'completed';
    }
    return 'pending';
  }

  // æ ¹æ“šä¸­æ–‡ç‹€æ…‹æ–‡å­—è¿”å›å°æ‡‰çš„ class
  function getStatusClassFromText(statusText) {
    if (!statusText) return 'status-step-1';
    
    const statusTextMap = {
      'è¨‚å–®å·²å»ºç«‹': 'status-step-1',
      'è²¨ä»¶å·²æ”¶å–': 'status-step-2',
      'èµ·é‹åœ°æµ·é—œè™•ç†': 'status-step-3',
      'é‹é€ä¸­': 'status-step-4',
      'ç›®çš„åœ°æµ·é—œè™•ç†': 'status-step-5',
      'é…é€ä¸­': 'status-step-6',
      'è²¨ä»¶å·²é€é”': 'status-step-7',
      'è™•ç†ä¸­': 'status-step-4',
      'å¾…è™•ç†': 'status-step-1',
      'å·²å®Œæˆ': 'status-step-7',
      'å·²é€é”': 'status-step-7',
    };
    
    // å…ˆå˜—è©¦å®Œå…¨åŒ¹é…
    if (statusTextMap[statusText]) {
      return statusTextMap[statusText];
    }
    
    // å˜—è©¦éƒ¨åˆ†åŒ¹é…
    for (const [key, value] of Object.entries(statusTextMap)) {
      if (statusText.includes(key)) {
        return value;
      }
    }
    
    // é è¨­è¿”å›ç¬¬ä¸€å€‹ç‹€æ…‹
    return 'status-step-1';
  }

  // è½‰æ›æ­¥é©Ÿåç¨±çš„å‡½æ•¸ï¼ˆèˆ‡æŸ¥è©¢é é¢ä¸€è‡´ï¼‰
  function translateStepName(originalTitle) {
    if (!originalTitle) return '';
    const stepNameMapping = window.CONFIG?.content?.results?.stepNameMapping || {};
    // å…ˆå˜—è©¦å®Œå…¨åŒ¹é…
    if (stepNameMapping[originalTitle]) {
      return stepNameMapping[originalTitle];
    }
    // å˜—è©¦ä¸å€åˆ†å¤§å°å¯«åŒ¹é…
    const lowerOriginal = originalTitle.toLowerCase().trim();
    for (const [key, value] of Object.entries(stepNameMapping)) {
      if (key.toLowerCase().trim() === lowerOriginal) {
        return value;
      }
    }
    // å¦‚æœæ²’æœ‰åŒ¹é…ï¼Œè¿”å›åŸå§‹åç¨±
    return originalTitle;
  }

  const defaultCheckboxLabels = {
    '02': translateStepName('Order Created'),
    '03': translateStepName('Shipment Collected'),
    '04': translateStepName('Origin Customs Process'),
    '05': translateStepName('In Transit'),
    '06': translateStepName('Destination Customs Process'),
    '07': translateStepName('Out for Delivery'),
  };

  const checkboxLabelMapping =
    window.CONFIG?.content?.listPage?.checkboxLabels || defaultCheckboxLabels;

  function getCheckboxLabel(key) {
    return checkboxLabelMapping[key] || `ç‹€æ…‹ ${key}`;
  }

  function formatStatus(status, latestTimelineTitle) {
    // ä½¿ç”¨èˆ‡æŸ¥è©¢é é¢ç›¸åŒçš„é‚è¼¯ï¼šå„ªå…ˆä½¿ç”¨ latestTimelineTitle
    // é€™èˆ‡ renderShipmentInfo ä¸­çš„ statusText ç”Ÿæˆé‚è¼¯ä¸€è‡´
    if (latestTimelineTitle) {
      return translateStepName(latestTimelineTitle);
    }
    
    // å¦‚æœæ²’æœ‰ timeline titleï¼Œä½¿ç”¨ status çš„æ˜ å°„
    if (!status) return 'å¾…è™•ç†';
    const statusMap = {
      'processing': 'è™•ç†ä¸­',
      'in_transit': 'é‹é€ä¸­',
      'completed': 'å·²å®Œæˆ',
      'delivered': 'å·²é€é”',
      'pending': 'å¾…è™•ç†',
    };
    return statusMap[status.toLowerCase()] || status;
  }

  function formatDate(dateString) {
    if (!dateString) return '';
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
      });
    } catch (e) {
      return dateString;
    }
  }

  // Lightbox åŠŸèƒ½
  let currentShipments = [];
  
  function showCheckboxLightbox(index) {
    const shipment = currentShipments[index];
    if (!shipment || !shipment.checkboxFields) return;
    
    const checkboxFields = shipment.checkboxFields;
    const checkedItems = Object.entries(checkboxFields)
      .filter(([key, value]) => value === true)
      .map(([key]) => `${key} - ${getCheckboxLabel(key)}`);
    
    const lightboxHTML = `
      <div class="lightbox-overlay" id="checkboxLightbox">
        <div class="lightbox-content">
          <div class="lightbox-header">
            <h3>è©³ç´°è³‡è¨Š</h3>
            <button class="lightbox-close" aria-label="é—œé–‰">&times;</button>
          </div>
          <div class="lightbox-body">
            <div class="info-section">
              <h4>è¨‚å–®è³‡è¨Š</h4>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">è¨‚å–®ç·¨è™Ÿï¼š</span>
                  <span class="info-value">${escapeHtml(shipment.orderNo) || 'â€”'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">è¿½è¹¤è™Ÿç¢¼ï¼š</span>
                  <span class="info-value">${escapeHtml(shipment.trackingNo) || 'â€”'}</span>
                </div>
              </div>
            </div>
            <div class="checkbox-section">
              <h4>ç‹€æ…‹æ¨™è¨˜ <span style="font-size: 12px; font-weight: normal; color: #666;">(é»æ“Šåˆ‡æ›)</span></h4>
              <div class="checkbox-grid" id="checkboxGrid_${index}">
                ${['02', '03', '04', '05', '06', '07'].map(key => {
                  const isChecked = checkboxFields[key] === true;
                  const labelText = escapeHtml(getCheckboxLabel(key));
                  return `
                  <label class="checkbox-item ${isChecked ? 'checked' : 'unchecked'}" 
                         data-key="${key}" 
                         data-record-id="${shipment.id}"
                         style="cursor: pointer;">
                    <input type="checkbox" 
                           class="checkbox-input" 
                           data-key="${key}"
                           ${isChecked ? 'checked' : ''}
                           style="display: none;">
                    <span class="checkbox-icon">${isChecked ? 'âœ“' : 'â—‹'}</span>
                    <span class="checkbox-label">${key} - ${labelText}</span>
                  </label>
                `;
                }).join('')}
              </div>
              <p class="checkbox-summary" id="checkboxSummary_${index}">
                ${checkedItems.length > 0 
                  ? `å·²å‹¾é¸ï¼š${checkedItems.join(', ')}`
                  : 'ç„¡å‹¾é¸é …ç›®'
                }
              </p>
              <div class="checkbox-actions" style="margin-top: 16px; display: flex; gap: 8px;">
                <button class="btn-save" data-index="${index}" style="padding: 8px 16px; background: #0D23A0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                  å„²å­˜è®Šæ›´
                </button>
                <button class="btn-cancel" data-index="${index}" style="padding: 8px 16px; background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px;">
                  å–æ¶ˆ
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // ç§»é™¤ç¾æœ‰çš„ lightboxï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const existingLightbox = document.getElementById('checkboxLightbox');
    if (existingLightbox) {
      existingLightbox.remove();
    }
    
    // æ·»åŠ æ–°çš„ lightbox
    document.body.insertAdjacentHTML('beforeend', lightboxHTML);
    
    // ç¶å®šé—œé–‰äº‹ä»¶
    const lightbox = document.getElementById('checkboxLightbox');
    const closeBtn = lightbox.querySelector('.lightbox-close');
    const overlay = lightbox.querySelector('.lightbox-overlay') || lightbox;
    
    closeBtn.addEventListener('click', () => closeLightbox());
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay || e.target === lightbox) {
        closeLightbox();
      }
    });
    
    // ESC éµé—œé–‰
    document.addEventListener('keydown', function escHandler(e) {
      if (e.key === 'Escape') {
        closeLightbox();
        document.removeEventListener('keydown', escHandler);
      }
    });
  }
  
  function closeLightbox() {
    const lightbox = document.getElementById('checkboxLightbox');
    if (lightbox) {
      lightbox.classList.add('fade-out');
      setTimeout(() => {
        lightbox.remove();
      }, 300);
    }
  }
  
  // é¡¯ç¤ºç·¨è¼¯ lightbox
  function showEditLightbox(index) {
    const shipment = currentShipments[index];
    if (!shipment) return;
    
    // è§£æ Origin/Destinationï¼ˆå¦‚æœæœ‰ â†’ åˆ†éš”ç¬¦ï¼‰
    const originDest = shipment.originDestination || '';
    const originDestParts = originDest.includes('â†’') 
      ? originDest.split('â†’').map(s => s.trim())
      : ['', ''];
    const originValue = shipment.origin || originDestParts[0] || '';
    const destinationValue = shipment.destination || originDestParts[1] || '';
    
    // è™•ç† Weightï¼ˆç§»é™¤ "KG" å¾Œç¶´ï¼‰
    const weightValue = (shipment.weight || '').replace(/\s*KG\s*/gi, '').trim();
    
    const lightboxHTML = `
      <div class="lightbox-overlay" id="editLightbox">
        <div class="lightbox-content" style="max-width: 800px;">
          <div class="lightbox-header">
            <h3>ç·¨è¼¯è²¨ä»¶è³‡æ–™</h3>
            <button class="lightbox-close" aria-label="é—œé–‰">&times;</button>
          </div>
          <div class="lightbox-body">
            <div class="info-section">
              <h4>åŸºæœ¬è³‡è¨Š</h4>
              <div class="info-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="info-item">
                  <label class="info-label">è¨‚å–®ç·¨è™Ÿ (Job No.)ï¼š</label>
                  <input type="text" class="edit-input" id="edit-orderNo" value="${escapeHtml(shipment.orderNo) || ''}" placeholder="ä¾‹å¦‚ï¼šDG700">
                </div>
                <div class="info-item">
                  <label class="info-label">è¿½è¹¤è™Ÿç¢¼ (Tracking No.)ï¼š</label>
                  <input type="text" class="edit-input" id="edit-trackingNo" value="${escapeHtml(shipment.trackingNo) || ''}" placeholder="ä¾‹å¦‚ï¼šYZAB6789">
                </div>
              </div>
            </div>
            
            <div class="info-section">
              <h4>é‹è¼¸è³‡è¨Š</h4>
              <div class="info-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="info-item">
                  <label class="info-label">èµ·é‹åœ° (Origin)ï¼š</label>
                  <input type="text" class="edit-input" id="edit-origin" value="${escapeHtml(originValue)}" placeholder="ä¾‹å¦‚ï¼šTaiwan">
                </div>
                <div class="info-item">
                  <label class="info-label">ç›®çš„åœ° (Destination)ï¼š</label>
                  <input type="text" class="edit-input" id="edit-destination" value="${escapeHtml(destinationValue)}" placeholder="ä¾‹å¦‚ï¼šUSA">
                </div>
                <div class="info-item">
                  <label class="info-label">é‹è¼¸é¡å‹ (Transport Type)ï¼š</label>
                  <select class="edit-input" id="edit-transportType">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="Domestic" ${shipment.transportType === 'Domestic' ? 'selected' : ''}>Domestic</option>
                    <option value="Import" ${shipment.transportType === 'Import' ? 'selected' : ''}>Import</option>
                    <option value="Export" ${shipment.transportType === 'Export' ? 'selected' : ''}>Export</option>
                    <option value="Cross" ${shipment.transportType === 'Cross' ? 'selected' : ''}>Cross</option>
                    <option value="Import/Export" ${shipment.transportType === 'Import/Export' ? 'selected' : ''}>Import/Export</option>
                    <option value="Import/Export/Cross" ${shipment.transportType === 'Import/Export/Cross' ? 'selected' : ''}>Import/Export/Cross</option>
                  </select>
                </div>
                <div class="info-item">
                  <label class="info-label">åŒ…è£¹æ•¸é‡ (Package Count)ï¼š</label>
                  <input type="number" class="edit-input" id="edit-packageCount" value="${escapeHtml(shipment.packageCount) || '1'}" min="1">
                </div>
                <div class="info-item">
                  <label class="info-label">é‡é‡ (Weight, KG)ï¼š</label>
                  <input type="text" class="edit-input" id="edit-weight" value="${escapeHtml(weightValue)}" placeholder="ä¾‹å¦‚ï¼š10.5">
                </div>
                <div class="info-item">
                  <label class="info-label">é è¨ˆåˆ°é” (ETA)ï¼š</label>
                  <input type="datetime-local" class="edit-input" id="edit-eta" value="${shipment.eta ? new Date(shipment.eta).toISOString().slice(0, 16) : ''}">
                </div>
              </div>
            </div>
            
            <div class="info-section">
              <h4>å…¶ä»–è³‡è¨Š</h4>
              <div class="info-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="info-item">
                  <label class="info-label">ç™¼ç¥¨è™Ÿç¢¼ (Invoice No.)ï¼š</label>
                  <input type="text" class="edit-input" id="edit-invoiceNo" value="${escapeHtml(shipment.invoiceNo) || ''}" placeholder="ä¾‹å¦‚ï¼šINV-12345">
                </div>
                <div class="info-item">
                  <label class="info-label">ä¸»æå–®è™Ÿ (MAWB)ï¼š</label>
                  <input type="text" class="edit-input" id="edit-mawb" value="${escapeHtml(shipment.mawb) || ''}" placeholder="ä¾‹å¦‚ï¼šMAWB-12345">
                </div>
              </div>
            </div>
            
            <div class="checkbox-actions" style="margin-top: 24px; display: flex; gap: 8px; justify-content: flex-end;">
              <button class="btn-cancel" style="padding: 8px 16px; background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px;">
                å–æ¶ˆ
              </button>
              <button class="btn-save-edit" data-index="${index}" style="padding: 8px 16px; background: #0D23A0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                å„²å­˜è®Šæ›´
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // ç§»é™¤ç¾æœ‰çš„ lightboxï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const existingLightbox = document.getElementById('editLightbox');
    if (existingLightbox) {
      existingLightbox.remove();
    }
    
    // æ·»åŠ æ–°çš„ lightbox
    document.body.insertAdjacentHTML('beforeend', lightboxHTML);
    
    // ç¶å®šé—œé–‰äº‹ä»¶
    const lightbox = document.getElementById('editLightbox');
    const closeBtn = lightbox.querySelector('.lightbox-close');
    const overlay = lightbox.querySelector('.lightbox-overlay') || lightbox;
    
    closeBtn.addEventListener('click', () => closeEditLightbox());
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay || e.target === lightbox) {
        closeEditLightbox();
      }
    });
    
    // ESC éµé—œé–‰
    document.addEventListener('keydown', function escHandler(e) {
      if (e.key === 'Escape') {
        closeEditLightbox();
        document.removeEventListener('keydown', escHandler);
      }
    });
  }
  
  function closeEditLightbox() {
    const lightbox = document.getElementById('editLightbox');
    if (lightbox) {
      lightbox.classList.add('fade-out');
      setTimeout(() => {
        lightbox.remove();
      }, 300);
    }
  }
  
  // ç¶å®š checkbox æŒ‰éˆ•é»æ“Šäº‹ä»¶
  document.addEventListener('click', (e) => {
    if (e.target.closest('.btn-checkbox-info')) {
      const button = e.target.closest('.btn-checkbox-info');
      const index = parseInt(button.getAttribute('data-index'));
      showCheckboxLightbox(index);
    }
    
    if (e.target.closest('.btn-edit')) {
      const button = e.target.closest('.btn-edit');
      const index = parseInt(button.getAttribute('data-index'));
      showEditLightbox(index);
    }
    
    // è™•ç† checkbox åˆ‡æ›
    if (e.target.closest('.checkbox-item')) {
      const checkboxItem = e.target.closest('.checkbox-item');
      const checkboxInput = checkboxItem.querySelector('.checkbox-input');
      if (checkboxInput && !e.target.closest('.btn-save') && !e.target.closest('.btn-cancel')) {
        checkboxInput.checked = !checkboxInput.checked;
        updateCheckboxItemStyle(checkboxItem, checkboxInput.checked);
        updateCheckboxSummary(checkboxItem.closest('.lightbox-content'));
      }
    }
    
    // è™•ç†å„²å­˜æŒ‰éˆ•
    if (e.target.closest('.btn-save')) {
      const button = e.target.closest('.btn-save');
      const index = parseInt(button.getAttribute('data-index'));
      saveCheckboxChanges(index);
    }
    
    // è™•ç†å–æ¶ˆæŒ‰éˆ•
    if (e.target.closest('.btn-cancel')) {
      const lightbox = document.getElementById('checkboxLightbox') || document.getElementById('editLightbox');
      if (lightbox) {
        if (lightbox.id === 'checkboxLightbox') {
          closeLightbox();
        } else {
          closeEditLightbox();
        }
      }
    }
    
    // è™•ç†ç·¨è¼¯å„²å­˜æŒ‰éˆ•
    if (e.target.closest('.btn-save-edit')) {
      const button = e.target.closest('.btn-save-edit');
      const index = parseInt(button.getAttribute('data-index'));
      saveEditChanges(index);
    }
  });
  
  function updateCheckboxItemStyle(item, isChecked) {
    if (isChecked) {
      item.classList.remove('unchecked');
      item.classList.add('checked');
      item.querySelector('.checkbox-icon').textContent = 'âœ“';
    } else {
      item.classList.remove('checked');
      item.classList.add('unchecked');
      item.querySelector('.checkbox-icon').textContent = 'â—‹';
    }
  }
  
  function updateCheckboxSummary(lightboxContent) {
    const checkboxGrid = lightboxContent.querySelector('.checkbox-grid');
    const summary = lightboxContent.querySelector('.checkbox-summary');
    if (!checkboxGrid || !summary) return;
    
    const checkedItems = [];
    checkboxGrid.querySelectorAll('.checkbox-input:checked').forEach(input => {
      const key = input.getAttribute('data-key');
      checkedItems.push(`${key} - ${getCheckboxLabel(key)}`);
    });
    
    summary.textContent = checkedItems.length > 0 
      ? `å·²å‹¾é¸ï¼š${checkedItems.join(', ')}`
      : 'ç„¡å‹¾é¸é …ç›®';
  }
  
  async function saveCheckboxChanges(index) {
    const shipment = currentShipments[index];
    if (!shipment) return;
    
    const lightbox = document.getElementById('checkboxLightbox');
    if (!lightbox) return;
    
    const checkboxGrid = lightbox.querySelector('.checkbox-grid');
    if (!checkboxGrid) return;
    
    // æ”¶é›†æ‰€æœ‰ checkbox çš„ç‹€æ…‹
    const checkboxUpdates = {};
    checkboxGrid.querySelectorAll('.checkbox-input').forEach(input => {
      const key = input.getAttribute('data-key');
      checkboxUpdates[key] = input.checked;
    });
    
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    const saveBtn = lightbox.querySelector('.btn-save');
    const originalText = saveBtn.textContent;
    saveBtn.disabled = true;
    saveBtn.textContent = 'å„²å­˜ä¸­...';
    
    try {
      const response = await fetch('/api/update-checkbox', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          recordId: shipment.id,
          checkboxUpdates: checkboxUpdates,
        }),
      });
      
      const result = await response.json();
      
      if (!response.ok || !result.success) {
        throw new Error(result.message || 'æ›´æ–°å¤±æ•—');
      }
      
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      saveBtn.textContent = 'âœ“ å·²å„²å­˜';
      saveBtn.style.background = '#4caf50';
      
      setTimeout(() => {
        closeLightbox();
        // é‡æ–°è¼‰å…¥åˆ—è¡¨ä»¥åæ˜ è®Šæ›´ï¼ˆå¼·åˆ¶é‡æ–°ç²å–è³‡æ–™ï¼Œä¸ä½¿ç”¨å¿«å–ï¼‰
        fetchShipmentsList(true);
      }, 1000);
      
    } catch (error) {
      console.error('âŒ å„²å­˜å¤±æ•—:', error);
      saveBtn.textContent = 'âœ— å„²å­˜å¤±æ•—';
      saveBtn.style.background = '#f44336';
      setTimeout(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
        saveBtn.style.background = '#0D23A0';
      }, 2000);
    }
  }

  // å„²å­˜ç·¨è¼¯è®Šæ›´
  async function saveEditChanges(index) {
    const shipment = currentShipments[index];
    if (!shipment) return;
    
    const lightbox = document.getElementById('editLightbox');
    if (!lightbox) return;
    
    // æ”¶é›†æ‰€æœ‰è¼¸å…¥æ¬„ä½çš„å€¼
    const updates = {
      orderNo: document.getElementById('edit-orderNo')?.value.trim() || '',
      trackingNo: document.getElementById('edit-trackingNo')?.value.trim() || '',
      origin: document.getElementById('edit-origin')?.value.trim() || '',
      destination: document.getElementById('edit-destination')?.value.trim() || '',
      transportType: document.getElementById('edit-transportType')?.value || '',
      packageCount: document.getElementById('edit-packageCount')?.value || '',
      weight: document.getElementById('edit-weight')?.value.trim() || '',
      eta: document.getElementById('edit-eta')?.value || '',
      invoiceNo: document.getElementById('edit-invoiceNo')?.value.trim() || '',
      mawb: document.getElementById('edit-mawb')?.value.trim() || '',
    };
    
    // è™•ç†é‡é‡ï¼ˆå¦‚æœæ²’æœ‰ "KG" å¾Œç¶´ï¼ŒåŠ ä¸Šå®ƒï¼‰
    if (updates.weight && !updates.weight.toUpperCase().includes('KG')) {
      updates.weight = updates.weight.trim() + ' KG';
    }
    
    // è™•ç† Origin/Destinationï¼ˆåˆä½µç‚ºä¸€å€‹æ¬„ä½ï¼‰
    let originDestination = '';
    if (updates.origin && updates.destination) {
      originDestination = `${updates.origin} â†’ ${updates.destination}`;
    } else if (updates.origin) {
      originDestination = updates.origin;
    } else if (updates.destination) {
      originDestination = updates.destination;
    }
    
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    const saveBtn = lightbox.querySelector('.btn-save-edit');
    const originalText = saveBtn.textContent;
    saveBtn.disabled = true;
    saveBtn.textContent = 'å„²å­˜ä¸­...';
    
    try {
      const response = await fetch('/api/update-shipment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          recordId: shipment.id,
          updates: {
            // æ³¨æ„ï¼š'Job No.' æ˜¯è¨ˆç®—æ¬„ä½ï¼Œä¸èƒ½æ›´æ–°ï¼Œæ‰€ä»¥ç§»é™¤
            'Tracking No.': updates.trackingNo,
            'Origin/Destination': originDestination,
            'Origin': updates.origin,
            'Destination': updates.destination,
            'Transport Type': updates.transportType,
            'Package Count': updates.packageCount ? parseInt(updates.packageCount, 10) : null,
            'Weight(KG)': updates.weight,
            'ETA': updates.eta || null,
            'Invoice No.': updates.invoiceNo,
            'MAWB': updates.mawb,
          },
        }),
      });
      
      const result = await response.json();
      
      if (!response.ok || !result.success) {
        throw new Error(result.message || 'æ›´æ–°å¤±æ•—');
      }
      
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      saveBtn.textContent = 'âœ“ å·²å„²å­˜';
      saveBtn.style.background = '#4caf50';
      
      setTimeout(() => {
        closeEditLightbox();
        // é‡æ–°è¼‰å…¥åˆ—è¡¨ä»¥åæ˜ è®Šæ›´ï¼ˆå¼·åˆ¶é‡æ–°ç²å–è³‡æ–™ï¼Œä¸ä½¿ç”¨å¿«å–ï¼‰
        fetchShipmentsList(true);
      }, 1000);
      
    } catch (error) {
      console.error('âŒ å„²å­˜å¤±æ•—:', error);
      saveBtn.textContent = 'âœ— å„²å­˜å¤±æ•—';
      saveBtn.style.background = '#f44336';
      setTimeout(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
        saveBtn.style.background = '#0D23A0';
      }, 2000);
    }
  }

  // æ–°å¢è²¨ä»¶åŠŸèƒ½
  const addBtn = document.getElementById('addBtn');
  
  function openAddLightbox() {
    const lightboxHTML = `
      <div class="lightbox-overlay" id="addLightbox">
        <div class="lightbox-content" style="max-width: 800px;">
          <div class="lightbox-header">
            <h3>æ–°å¢è²¨ä»¶è³‡æ–™</h3>
            <button class="lightbox-close" aria-label="é—œé–‰">&times;</button>
          </div>
          <div class="lightbox-body">
            <div class="info-section">
              <h4>åŸºæœ¬è³‡è¨Š</h4>
              <div class="info-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="info-item">
                  <label class="info-label">è¿½è¹¤è™Ÿç¢¼ (Tracking No.)ï¼š<span style="color: red;">*</span></label>
                  <input type="text" class="edit-input" id="add-trackingNo" placeholder="ä¾‹å¦‚ï¼šYZAB6789" required>
                </div>
              </div>
            </div>
            
            <div class="info-section">
              <h4>é‹è¼¸è³‡è¨Š</h4>
              <div class="info-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="info-item">
                  <label class="info-label">èµ·é‹åœ° (Origin)ï¼š</label>
                  <input type="text" class="edit-input" id="add-origin" placeholder="ä¾‹å¦‚ï¼šTaiwan">
                </div>
                <div class="info-item">
                  <label class="info-label">ç›®çš„åœ° (Destination)ï¼š</label>
                  <input type="text" class="edit-input" id="add-destination" placeholder="ä¾‹å¦‚ï¼šUSA">
                </div>
                <div class="info-item">
                  <label class="info-label">é‹è¼¸é¡å‹ (Transport Type)ï¼š</label>
                  <select class="edit-input" id="add-transportType">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="Domestic">Domestic</option>
                    <option value="Import">Import</option>
                    <option value="Export">Export</option>
                    <option value="Cross">Cross</option>
                    <option value="Import/Export">Import/Export</option>
                    <option value="Import/Export/Cross">Import/Export/Cross</option>
                  </select>
                </div>
                <div class="info-item">
                  <label class="info-label">åŒ…è£¹æ•¸é‡ (Package Count)ï¼š</label>
                  <input type="number" class="edit-input" id="add-packageCount" value="1" min="1">
                </div>
                <div class="info-item">
                  <label class="info-label">é‡é‡ (Weight, KG)ï¼š</label>
                  <input type="text" class="edit-input" id="add-weight" placeholder="ä¾‹å¦‚ï¼š10.5">
                </div>
                <div class="info-item">
                  <label class="info-label">é è¨ˆåˆ°é” (ETA)ï¼š</label>
                  <input type="datetime-local" class="edit-input" id="add-eta">
                </div>
              </div>
            </div>
            
            <div class="info-section">
              <h4>å…¶ä»–è³‡è¨Š</h4>
              <div class="info-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="info-item">
                  <label class="info-label">ç™¼ç¥¨è™Ÿç¢¼ (Invoice No.)ï¼š</label>
                  <input type="text" class="edit-input" id="add-invoiceNo" placeholder="ä¾‹å¦‚ï¼šINV-12345">
                </div>
                <div class="info-item">
                  <label class="info-label">ä¸»æå–®è™Ÿ (MAWB)ï¼š</label>
                  <input type="text" class="edit-input" id="add-mawb" placeholder="ä¾‹å¦‚ï¼šMAWB-12345">
                </div>
              </div>
            </div>
            
            <div class="checkbox-actions" style="margin-top: 24px; display: flex; gap: 8px; justify-content: flex-end;">
              <button class="btn-cancel-add" style="padding: 8px 16px; background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px;">
                å–æ¶ˆ
              </button>
              <button class="btn-save-add" style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                æ–°å¢è²¨ä»¶
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // ç§»é™¤ç¾æœ‰çš„ lightboxï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const existingLightbox = document.getElementById('addLightbox');
    if (existingLightbox) {
      existingLightbox.remove();
    }
    
    // æ·»åŠ æ–°çš„ lightbox
    document.body.insertAdjacentHTML('beforeend', lightboxHTML);
    
    // ç¶å®šé—œé–‰äº‹ä»¶
    const lightbox = document.getElementById('addLightbox');
    const closeBtn = lightbox.querySelector('.lightbox-close');
    const cancelBtn = lightbox.querySelector('.btn-cancel-add');
    
    function closeLightbox() {
      lightbox.remove();
    }
    
    closeBtn.addEventListener('click', closeLightbox);
    cancelBtn.addEventListener('click', closeLightbox);
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) {
        closeLightbox();
      }
    });
    
    // ç¶å®šå„²å­˜äº‹ä»¶
    const saveBtn = lightbox.querySelector('.btn-save-add');
    saveBtn.addEventListener('click', saveNewShipment);
  }
  
  async function saveNewShipment() {
    const lightbox = document.getElementById('addLightbox');
    if (!lightbox) return;
    
    // æ”¶é›†æ‰€æœ‰è¼¸å…¥æ¬„ä½çš„å€¼
    const shipmentData = {
      'Tracking No.': document.getElementById('add-trackingNo')?.value.trim() || '',
      'Origin': document.getElementById('add-origin')?.value.trim() || '',
      'Destination': document.getElementById('add-destination')?.value.trim() || '',
      'Transport Type': document.getElementById('add-transportType')?.value || '',
      'Package Count': document.getElementById('add-packageCount')?.value || '',
      'Weight(KG)': document.getElementById('add-weight')?.value.trim() || '',
      'ETA': document.getElementById('add-eta')?.value || '',
      'Invoice No.': document.getElementById('add-invoiceNo')?.value.trim() || '',
      'MAWB': document.getElementById('add-mawb')?.value.trim() || '',
    };
    
    // é©—è­‰å¿…å¡«æ¬„ä½
    if (!shipmentData['Tracking No.']) {
      alert('è«‹è¼¸å…¥è¿½è¹¤è™Ÿç¢¼');
      return;
    }
    
    // è™•ç† Origin/Destinationï¼ˆåˆä½µç‚ºä¸€å€‹æ¬„ä½ï¼‰
    let originDestination = '';
    if (shipmentData['Origin'] && shipmentData['Destination']) {
      originDestination = `${shipmentData['Origin']} â†’ ${shipmentData['Destination']}`;
    } else if (shipmentData['Origin']) {
      originDestination = shipmentData['Origin'];
    } else if (shipmentData['Destination']) {
      originDestination = shipmentData['Destination'];
    }
    if (originDestination) {
      shipmentData['Origin/Destination'] = originDestination;
    }
    
    // è™•ç†é‡é‡ï¼ˆå¦‚æœæ²’æœ‰ "KG" å¾Œç¶´ï¼ŒåŠ ä¸Šå®ƒï¼‰
    if (shipmentData['Weight(KG)'] && !shipmentData['Weight(KG)'].toUpperCase().includes('KG')) {
      shipmentData['Weight(KG)'] = shipmentData['Weight(KG)'].trim() + ' KG';
    }
    
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    const saveBtn = lightbox.querySelector('.btn-save-add');
    const originalText = saveBtn.textContent;
    saveBtn.disabled = true;
    saveBtn.textContent = 'æ–°å¢ä¸­...';
    
    try {
      const response = await fetch('/api/create-shipment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          shipmentData: shipmentData,
        }),
      });
      
      const result = await response.json();
      
      if (!response.ok || !result.success) {
        throw new Error(result.message || 'æ–°å¢å¤±æ•—');
      }
      
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      saveBtn.textContent = 'âœ“ å·²æ–°å¢';
      saveBtn.style.background = '#4caf50';
      
      setTimeout(() => {
        lightbox.remove();
        // é‡æ–°è¼‰å…¥åˆ—è¡¨ä»¥åæ˜ è®Šæ›´
        fetchShipmentsList(true);
      }, 1000);
      
    } catch (error) {
      console.error('âŒ æ–°å¢å¤±æ•—:', error);
      saveBtn.textContent = 'âœ— æ–°å¢å¤±æ•—';
      saveBtn.style.background = '#f44336';
      setTimeout(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
        saveBtn.style.background = '#4caf50';
      }, 2000);
      alert('æ–°å¢å¤±æ•—ï¼š' + error.message);
    }
  }
  
  // ç¶å®šæ–°å¢æŒ‰éˆ•äº‹ä»¶
  if (addBtn) {
    addBtn.addEventListener('click', openAddLightbox);
  }

  // åˆå§‹åŒ–
  refreshBtn.addEventListener('click', fetchShipmentsList);
  fetchShipmentsList();

