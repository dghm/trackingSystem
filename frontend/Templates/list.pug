//- ä½¿ç”¨é…ç½®è®Šæ•¸ï¼ˆconfig ç”± compile-multi-client.js æ³¨å…¥ï¼‰
- const brand = typeof config !== 'undefined' && config ? (config.brand || {}) : {}
- const content = typeof config !== 'undefined' && config ? (config.content || {}) : {}
- const fonts = typeof config !== 'undefined' && config ? (config.fonts || {}) : {}

doctype html
html(lang="zh-TW")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title= (brand.name || 'Tracking System') + ' - è²¨ä»¶åˆ—è¡¨'
    link(rel="icon", type="image/svg+xml", href=brand.favicon || "./images/favicon.svg")
    link(rel="preconnect", href="https://fonts.googleapis.com")
    link(rel="preconnect", href="https://fonts.gstatic.com", crossorigin)
    - const fontFamily = fonts.primary || 'Noto Sans'
    - const encodedFont = encodeURIComponent(fontFamily)
    - const fontUrl = 'https://fonts.googleapis.com/css2?family=' + encodedFont + ':wght@300;400;500;600;700&display=swap'
    link(href=fontUrl, rel="stylesheet")
    link(rel="stylesheet", href="./css/main.css")
    script(src="./js/config.js")
    style.
      .list-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      .list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }
      .list-title {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
        margin: 0;
      }
      .list-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .btn-refresh {
        padding: 10px 20px;
        background: #0D23A0;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }
      .btn-refresh:hover {
        background: #0a1b7a;
      }
      .btn-refresh:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .list-stats {
        color: #666;
        font-size: 14px;
      }
      .list-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      .list-table thead {
        background: #f5f5f5;
      }
      .list-table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #ddd;
        font-size: 14px;
      }
      .list-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
      }
      .list-table tbody tr:hover {
        background: #f9f9f9;
      }
      .list-table tbody tr:last-child td {
        border-bottom: none;
      }
      .pagination {
        margin-top: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .pagination-info {
        font-size: 14px;
        color: #555;
      }
      .pagination-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .pagination button {
        padding: 8px 16px;
        border: 1px solid #ccc;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      .pagination button:disabled {
        cursor: not-allowed;
        color: #999;
        border-color: #ddd;
        background: #f5f5f5;
      }
      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      .status-processing {
        background: #fff3cd;
        color: #856404;
      }
      .status-completed {
        background: #d4edda;
        color: #155724;
      }
      .status-pending {
        background: #e2e3e5;
        color: #383d41;
      }
      .btn-checkbox-info {
        background: transparent;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        color: #666;
        display: inline-flex;
        align-items: center;
        transition: all 0.2s;
      }
      .btn-checkbox-info:hover {
        background: #f5f5f5;
        border-color: #0D23A0;
        color: #0D23A0;
      }
      .lightbox-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s;
      }
      .lightbox-overlay.fade-out {
        animation: fadeOut 0.3s;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
      .lightbox-content {
        background: white;
        border-radius: 8px;
        max-width: 640px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s;
      }
      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .lightbox-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #eee;
      }
      .lightbox-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
      }
      .lightbox-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #999;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
      }
      .lightbox-close:hover {
        background: #f5f5f5;
        color: #333;
      }
      .lightbox-body {
        padding: 20px;
      }
      .info-section, .checkbox-section {
        margin-bottom: 24px;
      }
      .info-section:last-child, .checkbox-section:last-child {
        margin-bottom: 0;
      }
      .info-section h4, .checkbox-section h4 {
        margin: 0 0 16px 0;
        font-size: 16px;
        font-weight: 600;
        color: #333;
      }
      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .info-label {
        font-size: 12px;
        color: #666;
      }
      .info-value {
        font-size: 14px;
        color: #333;
        font-weight: 500;
      }
      .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }
      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #ddd;
        transition: all 0.2s;
        user-select: none;
      }
      .checkbox-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .checkbox-item.checked {
        background: #e8f5e9;
        border-color: #4caf50;
      }
      .checkbox-item.unchecked {
        background: #f5f5f5;
        border-color: #ddd;
      }
      .btn-save:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .checkbox-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        font-weight: bold;
        font-size: 14px;
      }
      .checkbox-item.checked .checkbox-icon {
        background: #4caf50;
        color: white;
      }
      .checkbox-item.unchecked .checkbox-icon {
        background: #ddd;
        color: #999;
      }
      .checkbox-label {
        font-size: 14px;
        font-weight: 500;
        color: #333;
      }
      .checkbox-summary {
        margin-top: 16px;
        padding: 12px;
        background: #f5f5f5;
        border-radius: 6px;
        font-size: 14px;
        color: #666;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }
      .error {
        text-align: center;
        padding: 40px;
        color: #dc3545;
        background: #f8d7da;
        border-radius: 8px;
        margin: 20px 0;
      }
      .empty {
        text-align: center;
        padding: 40px;
        color: #666;
      }
      .link-tracking {
        color: #0D23A0;
        text-decoration: none;
        font-weight: 500;
      }
      .link-tracking:hover {
        text-decoration: underline;
      }
      @media (max-width: 768px) {
        .list-table {
          font-size: 12px;
        }
        .list-table th,
        .list-table td {
          padding: 8px;
        }
        .list-header {
          flex-direction: column;
          align-items: flex-start;
        }
      }
  body
    header.site-header
      .container
        .brand
          img.brand-logo(src=brand.logo || "./images/logo.png", alt=brand.name || "Logo")
          if brand.logoMobile
            img.brand-logo.brand-logo--mobile(src=brand.logoMobile, alt=brand.name || "Logo")
        if brand.website
          a.header-btn(href=brand.website)= brand.backHomeText || 'Back Home'
        a.header-btn(href="./index.html") è¿”å›è¿½è¹¤é é¢

    .list-container
      .list-header
        h1.list-title è²¨ä»¶åˆ—è¡¨
        .list-controls
          .list-stats#listStats è¼‰å…¥ä¸­...
          button.btn-refresh#refreshBtn é‡æ–°æ•´ç†

      #listContent
        .loading æ­£åœ¨è¼‰å…¥è³‡æ–™...

    script.
      // ä½¿ç”¨ window.CONFIG ä¸­çš„ API_BASE_URLï¼Œé¿å…é‡è¤‡å®£å‘Š
      const apiBaseUrl = window.CONFIG?.API_BASE_URL || '/.netlify/functions';
      const listContent = document.getElementById('listContent');
      const refreshBtn = document.getElementById('refreshBtn');
      const listStats = document.getElementById('listStats');
      const pageSize = 10;
      let currentPage = 1;
      let currentShipments = [];

      async function fetchShipmentsList(forceRefresh = false) {
        try {
          listContent.innerHTML = '<div class="loading">æ­£åœ¨è¼‰å…¥è³‡æ–™...</div>';
          refreshBtn.disabled = true;
          listStats.textContent = 'è¼‰å…¥ä¸­...';

          // ä½¿ç”¨ /api/list ç«¯é»ï¼Œå¼·åˆ¶é‡æ–°è¼‰å…¥æ™‚æ·»åŠ æ™‚é–“æˆ³é¿å…å¿«å–
          const apiUrl = forceRefresh 
            ? `/api/list?t=${Date.now()}`
            : '/api/list';
          console.log('ğŸ” è«‹æ±‚åˆ—è¡¨è³‡æ–™:', apiUrl, forceRefresh ? '(å¼·åˆ¶é‡æ–°è¼‰å…¥)' : '');
          
          // æ·»åŠ è¶…æ™‚æ§åˆ¶
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ™‚
          
          const startTime = Date.now();
          const response = await fetch(apiUrl, {
            signal: controller.signal,
            headers: {
              'Content-Type': 'application/json',
            },
            cache: forceRefresh ? 'no-cache' : 'default', // å¼·åˆ¶é‡æ–°è¼‰å…¥æ™‚ä¸ä½¿ç”¨å¿«å–
          });
          
          clearTimeout(timeoutId);
          const loadTime = ((Date.now() - startTime) / 1000).toFixed(2);
          console.log(`â±ï¸ è¼‰å…¥æ™‚é–“: ${loadTime} ç§’`);

          if (!response.ok) {
            const errorText = await response.text();
            console.error('âŒ API å›æ‡‰éŒ¯èª¤:', response.status, errorText);
            let errorData;
            try {
              errorData = JSON.parse(errorText);
            } catch (e) {
              errorData = { message: `HTTP ${response.status}: ${response.statusText}` };
            }
            throw new Error(errorData.message || errorData.error || 'è¼‰å…¥å¤±æ•—');
          }

          const result = await response.json();
          console.log('âœ… API å›æ‡‰:', result);

          if (!result.success) {
            throw new Error(result.message || result.error || 'è¼‰å…¥å¤±æ•—');
          }

          const shipments = result.data || [];
          console.log(`ğŸ“¦ æ”¶åˆ° ${shipments.length} ç­†è¨˜éŒ„`);
          
          if (shipments.length > 0) {
            console.log('ğŸ“‹ ç¬¬ä¸€ç­†è¨˜éŒ„ç¯„ä¾‹:', shipments[0]);
            if (shipments[0].checkboxFields) {
              console.log('ğŸ“‹ ç¬¬ä¸€ç­†è¨˜éŒ„çš„ checkbox ç‹€æ…‹:', shipments[0].checkboxFields);
            }
          }
          
          // æ›´æ–° currentShipmentsï¼ˆç¢ºä¿ä½¿ç”¨æœ€æ–°çš„è³‡æ–™ï¼‰
          currentShipments = shipments.map(s => ({ ...s })); // æ·±æ‹·è²ï¼Œç¢ºä¿è³‡æ–™ç¨ç«‹
          renderList(currentShipments, 1);
          listStats.textContent = `å…± ${shipments.length} ç­†è¨˜éŒ„ (è¼‰å…¥æ™‚é–“: ${loadTime}ç§’)`;
        } catch (error) {
          console.error('âŒ è¼‰å…¥åˆ—è¡¨å¤±æ•—:', error);
          let errorMessage = 'è¼‰å…¥å¤±æ•—';
          
          if (error.name === 'AbortError') {
            errorMessage = 'è«‹æ±‚è¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦';
          } else if (error.message) {
            errorMessage = error.message;
          }
          
          listContent.innerHTML = `
            <div class="error">
              <p><strong>${errorMessage}</strong></p>
              <p style="margin-top: 10px; font-size: 12px;">
                è«‹ç¢ºèªï¼š<br>
                1. API ç«¯é»æ˜¯å¦æ­£ç¢ºè¨­å®š<br>
                2. Airtable ç’°å¢ƒè®Šæ•¸æ˜¯å¦æ­£ç¢º<br>
                3. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸
              </p>
              <button onclick="fetchShipmentsList()" style="margin-top: 15px; padding: 8px 16px; background: #0D23A0; color: white; border: none; border-radius: 4px; cursor: pointer;">
                é‡æ–°è¼‰å…¥
              </button>
            </div>
          `;
          listStats.textContent = 'è¼‰å…¥å¤±æ•—';
        } finally {
          refreshBtn.disabled = false;
        }
      }

      function renderList(shipments, page = 1) {
        if (shipments.length === 0) {
          listContent.innerHTML = `
            <div class="empty">
              <p>ç›®å‰æ²’æœ‰è²¨ä»¶è¨˜éŒ„</p>
              <p style="margin-top: 10px; font-size: 12px; color: #999;">
                è«‹ç¢ºèª Airtable è³‡æ–™åº«ä¸­æ˜¯å¦æœ‰è³‡æ–™
              </p>
            </div>
          `;
          return;
        }

        const totalRecords = shipments.length;
        const totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
        currentPage = Math.min(Math.max(page, 1), totalPages);
        const startIndex = (currentPage - 1) * pageSize;
        const pageShipments = shipments.slice(startIndex, startIndex + pageSize);

        const tableHTML = `
          <table class="list-table">
            <thead>
              <tr>
                <th>åºè™Ÿ</th>
                <th>è¨‚å–®ç·¨è™Ÿ</th>
                <th>è¿½è¹¤è™Ÿç¢¼</th>
                <th>ç‹€æ…‹</th>
                <th>èµ·é‹åœ° â†’ ç›®çš„åœ°</th>
                <th>åŒ…è£¹æ•¸é‡</th>
                <th>é‡é‡</th>
                <th>é è¨ˆåˆ°é”</th>
                <th>æœ€å¾Œæ›´æ–°</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${pageShipments.map((shipment, index) => {
                // ç¢ºä¿è³‡æ–™å­˜åœ¨æ‰é¡¯ç¤ºé€£çµ
                const hasData = shipment.orderNo && shipment.trackingNo;
                const detailLink = hasData 
                  ? `<a href="./index.html?orderNo=${encodeURIComponent(shipment.orderNo)}&trackingNo=${encodeURIComponent(shipment.trackingNo)}" 
                         class="link-tracking" 
                         target="_blank">
                        æŸ¥çœ‹è©³æƒ…
                      </a>`
                  : '<span style="color: #999;">â€”</span>';
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ checkbox æ¬„ä½è³‡æ–™ï¼ˆå³ä½¿æ²’æœ‰å‹¾é¸ä¹Ÿé¡¯ç¤ºæŒ‰éˆ•ï¼Œæ–¹ä¾¿æŸ¥çœ‹å’Œç·¨è¼¯ï¼‰
                const checkboxFields = shipment.checkboxFields || {};
                const hasCheckboxFields = Object.keys(checkboxFields).length > 0;
                const checkboxButton = hasCheckboxFields 
                  ? `<button class="btn-checkbox-info" data-index="${startIndex + index}" title="æŸ¥çœ‹/ç·¨è¼¯ç‹€æ…‹æ¨™è¨˜">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M8 4V8M8 12H8.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                      </svg>
                    </button>`
                  : '';
                
                const sequenceNumber = startIndex + index + 1;

                return `
                <tr>
                  <td>${sequenceNumber}</td>
                  <td>${escapeHtml(shipment.orderNo) || 'â€”'}</td>
                  <td>${escapeHtml(shipment.trackingNo) || 'â€”'}</td>
                  <td>
                    <span class="status-badge status-${getStatusClass(shipment.status)}">
                      ${formatStatus(shipment.status, shipment.latestTimelineTitle)}
                    </span>
                  </td>
                  <td>${escapeHtml(shipment.originDestination) || 'â€”'}</td>
                  <td>${escapeHtml(shipment.packageCount) || 'â€”'}</td>
                  <td>${escapeHtml(shipment.weight) || 'â€”'}</td>
                  <td>${formatDate(shipment.eta) || 'â€”'}</td>
                  <td>${formatDate(shipment.lastUpdate) || 'â€”'}</td>
                  <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      ${detailLink}
                      ${checkboxButton}
                    </div>
                  </td>
                </tr>
              `;
              }).join('')}
            </tbody>
          </table>
        `;

        const paginationHTML = `
          <div class="pagination">
            <div class="pagination-info">
              ç¬¬ ${currentPage} / ${totalPages} é ï¼Œé¡¯ç¤º ${pageShipments.length} ç­†ï¼Œå…± ${totalRecords} ç­†
            </div>
            <div class="pagination-controls">
              <button class="pagination-btn" data-action="prev" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é </button>
              <button class="pagination-btn" data-action="next" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é </button>
            </div>
          </div>
        `;

        listContent.innerHTML = tableHTML + paginationHTML;
      }

      // é˜²æ­¢ XSS æ”»æ“Š
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function getStatusClass(status) {
        if (!status) return 'pending';
        const lowerStatus = status.toLowerCase();
        if (lowerStatus.includes('processing') || lowerStatus.includes('transit')) {
          return 'processing';
        }
        if (lowerStatus.includes('completed') || lowerStatus.includes('delivered')) {
          return 'completed';
        }
        return 'pending';
      }

      // è½‰æ›æ­¥é©Ÿåç¨±çš„å‡½æ•¸ï¼ˆèˆ‡æŸ¥è©¢é é¢ä¸€è‡´ï¼‰
      function translateStepName(originalTitle) {
        if (!originalTitle) return '';
        const stepNameMapping = window.CONFIG?.content?.results?.stepNameMapping || {};
        // å…ˆå˜—è©¦å®Œå…¨åŒ¹é…
        if (stepNameMapping[originalTitle]) {
          return stepNameMapping[originalTitle];
        }
        // å˜—è©¦ä¸å€åˆ†å¤§å°å¯«åŒ¹é…
        const lowerOriginal = originalTitle.toLowerCase().trim();
        for (const [key, value] of Object.entries(stepNameMapping)) {
          if (key.toLowerCase().trim() === lowerOriginal) {
            return value;
          }
        }
        // å¦‚æœæ²’æœ‰åŒ¹é…ï¼Œè¿”å›åŸå§‹åç¨±
        return originalTitle;
      }

      const defaultCheckboxLabels = {
        '02': translateStepName('Order Created'),
        '03': translateStepName('Shipment Collected'),
        '04': translateStepName('Origin Customs Process'),
        '05': translateStepName('In Transit'),
        '06': translateStepName('Destination Customs Process'),
        '07': translateStepName('Out for Delivery'),
      };

      const checkboxLabelMapping =
        window.CONFIG?.content?.listPage?.checkboxLabels || defaultCheckboxLabels;

      function getCheckboxLabel(key) {
        return checkboxLabelMapping[key] || `ç‹€æ…‹ ${key}`;
      }

      function formatStatus(status, latestTimelineTitle) {
        // ä½¿ç”¨èˆ‡æŸ¥è©¢é é¢ç›¸åŒçš„é‚è¼¯ï¼šå„ªå…ˆä½¿ç”¨ latestTimelineTitle
        // é€™èˆ‡ renderShipmentInfo ä¸­çš„ statusText ç”Ÿæˆé‚è¼¯ä¸€è‡´
        if (latestTimelineTitle) {
          return translateStepName(latestTimelineTitle);
        }
        
        // å¦‚æœæ²’æœ‰ timeline titleï¼Œä½¿ç”¨ status çš„æ˜ å°„
        if (!status) return 'å¾…è™•ç†';
        const statusMap = {
          'processing': 'è™•ç†ä¸­',
          'in_transit': 'é‹é€ä¸­',
          'completed': 'å·²å®Œæˆ',
          'delivered': 'å·²é€é”',
          'pending': 'å¾…è™•ç†',
        };
        return statusMap[status.toLowerCase()] || status;
      }

      function formatDate(dateString) {
        if (!dateString) return '';
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
          });
        } catch (e) {
          return dateString;
        }
      }

      // Lightbox åŠŸèƒ½ï¼ˆä½¿ç”¨å‰é¢å®£å‘Šçš„ currentShipmentsï¼‰
          
          function showCheckboxLightbox(index) {
            const shipment = currentShipments[index];
            if (!shipment || !shipment.checkboxFields) return;
            
            const checkboxFields = shipment.checkboxFields;
            const checkedItems = Object.entries(checkboxFields)
              .filter(([key, value]) => value === true)
              .map(([key]) => `${key} - ${getCheckboxLabel(key)}`);
            
            const lightboxHTML = `
              <div class="lightbox-overlay" id="checkboxLightbox">
                <div class="lightbox-content">
                  <div class="lightbox-header">
                    <h3>è©³ç´°è³‡è¨Š</h3>
                    <button class="lightbox-close" aria-label="é—œé–‰">&times;</button>
                  </div>
                  <div class="lightbox-body">
                    <div class="info-section">
                      <h4>è¨‚å–®è³‡è¨Š</h4>
                      <div class="info-grid">
                        <div class="info-item">
                          <span class="info-label">è¨‚å–®ç·¨è™Ÿï¼š</span>
                          <span class="info-value">${escapeHtml(shipment.orderNo) || 'â€”'}</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">è¿½è¹¤è™Ÿç¢¼ï¼š</span>
                          <span class="info-value">${escapeHtml(shipment.trackingNo) || 'â€”'}</span>
                        </div>
                      </div>
                    </div>
                    <div class="checkbox-section">
                      <h4>ç‹€æ…‹æ¨™è¨˜ <span style="font-size: 12px; font-weight: normal; color: #666;">(é»æ“Šåˆ‡æ›)</span></h4>
                      <div class="checkbox-grid" id="checkboxGrid_${index}">
                        ${['02', '03', '04', '05', '06', '07'].map(key => {
                          const isChecked = checkboxFields[key] === true;
                          const labelText = escapeHtml(getCheckboxLabel(key));
                          return `
                          <label class="checkbox-item ${isChecked ? 'checked' : 'unchecked'}" 
                                 data-key="${key}" 
                                 data-record-id="${shipment.id}"
                                 style="cursor: pointer;">
                            <input type="checkbox" 
                                   class="checkbox-input" 
                                   data-key="${key}"
                                   ${isChecked ? 'checked' : ''}
                                   style="display: none;">
                            <span class="checkbox-icon">${isChecked ? 'âœ“' : 'â—‹'}</span>
                            <span class="checkbox-label">${key} - ${labelText}</span>
                          </label>
                        `}).join('')}
                      </div>
                      <p class="checkbox-summary" id="checkboxSummary_${index}">
                        ${checkedItems.length > 0 
                          ? `å·²å‹¾é¸ï¼š${checkedItems.join(', ')}`
                          : 'ç„¡å‹¾é¸é …ç›®'
                        }
                      </p>
                      <div class="checkbox-actions" style="margin-top: 16px; display: flex; gap: 8px;">
                        <button class="btn-save" data-index="${index}" style="padding: 8px 16px; background: #0D23A0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                          å„²å­˜è®Šæ›´
                        </button>
                        <button class="btn-cancel" data-index="${index}" style="padding: 8px 16px; background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px;">
                          å–æ¶ˆ
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            // ç§»é™¤ç¾æœ‰çš„ lightboxï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingLightbox = document.getElementById('checkboxLightbox');
            if (existingLightbox) {
              existingLightbox.remove();
            }
            
            // æ·»åŠ æ–°çš„ lightbox
            document.body.insertAdjacentHTML('beforeend', lightboxHTML);
            
            // ç¶å®šé—œé–‰äº‹ä»¶
            const lightbox = document.getElementById('checkboxLightbox');
            const closeBtn = lightbox.querySelector('.lightbox-close');
            const overlay = lightbox.querySelector('.lightbox-overlay') || lightbox;
            
            closeBtn.addEventListener('click', () => closeLightbox());
            overlay.addEventListener('click', (e) => {
              if (e.target === overlay || e.target === lightbox) {
                closeLightbox();
              }
            });
            
            // ESC éµé—œé–‰
            document.addEventListener('keydown', function escHandler(e) {
              if (e.key === 'Escape') {
                closeLightbox();
                document.removeEventListener('keydown', escHandler);
              }
            });
          }
          
          function closeLightbox() {
            const lightbox = document.getElementById('checkboxLightbox');
            if (lightbox) {
              lightbox.classList.add('fade-out');
              setTimeout(() => {
                lightbox.remove();
              }, 300);
            }
          }
          
          // ç¶å®š checkbox æŒ‰éˆ•é»æ“Šäº‹ä»¶
          document.addEventListener('click', (e) => {
            const paginationBtn = e.target.closest('.pagination-btn');
            if (paginationBtn) {
              const action = paginationBtn.getAttribute('data-action');
              const totalPages = Math.max(1, Math.ceil(currentShipments.length / pageSize));
              if (action === 'prev' && currentPage > 1) {
                renderList(currentShipments, currentPage - 1);
              } else if (action === 'next' && currentPage < totalPages) {
                renderList(currentShipments, currentPage + 1);
              }
              return;
            }

            if (e.target.closest('.btn-checkbox-info')) {
              const button = e.target.closest('.btn-checkbox-info');
              const index = parseInt(button.getAttribute('data-index'));
              showCheckboxLightbox(index);
            }
            
            // è™•ç† checkbox åˆ‡æ›
            if (e.target.closest('.checkbox-item')) {
              const checkboxItem = e.target.closest('.checkbox-item');
              const checkboxInput = checkboxItem.querySelector('.checkbox-input');
              if (checkboxInput && !e.target.closest('.btn-save') && !e.target.closest('.btn-cancel')) {
                checkboxInput.checked = !checkboxInput.checked;
                updateCheckboxItemStyle(checkboxItem, checkboxInput.checked);
                updateCheckboxSummary(checkboxItem.closest('.lightbox-content'));
              }
            }
            
            // è™•ç†å„²å­˜æŒ‰éˆ•
            if (e.target.closest('.btn-save')) {
              const button = e.target.closest('.btn-save');
              const index = parseInt(button.getAttribute('data-index'));
              saveCheckboxChanges(index);
            }
            
            // è™•ç†å–æ¶ˆæŒ‰éˆ•
            if (e.target.closest('.btn-cancel')) {
              closeLightbox();
            }
          });
          
          function updateCheckboxItemStyle(item, isChecked) {
            if (isChecked) {
              item.classList.remove('unchecked');
              item.classList.add('checked');
              item.querySelector('.checkbox-icon').textContent = 'âœ“';
            } else {
              item.classList.remove('checked');
              item.classList.add('unchecked');
              item.querySelector('.checkbox-icon').textContent = 'â—‹';
            }
          }
          
          function updateCheckboxSummary(lightboxContent) {
            const checkboxGrid = lightboxContent.querySelector('.checkbox-grid');
            const summary = lightboxContent.querySelector('.checkbox-summary');
            if (!checkboxGrid || !summary) return;
            
            const checkedItems = [];
            checkboxGrid.querySelectorAll('.checkbox-input:checked').forEach(input => {
              const key = input.getAttribute('data-key');
              checkedItems.push(`${key} - ${getCheckboxLabel(key)}`);
            });
            
            summary.textContent = checkedItems.length > 0 
              ? `å·²å‹¾é¸ï¼š${checkedItems.join(', ')}`
              : 'ç„¡å‹¾é¸é …ç›®';
          }
          
          async function saveCheckboxChanges(index) {
            const shipment = currentShipments[index];
            if (!shipment) return;
            
            const lightbox = document.getElementById('checkboxLightbox');
            if (!lightbox) return;
            
            const checkboxGrid = lightbox.querySelector('.checkbox-grid');
            if (!checkboxGrid) return;
            
            // æ”¶é›†æ‰€æœ‰ checkbox çš„ç‹€æ…‹
            const checkboxUpdates = {};
            checkboxGrid.querySelectorAll('.checkbox-input').forEach(input => {
              const key = input.getAttribute('data-key');
              checkboxUpdates[key] = input.checked;
            });
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const saveBtn = lightbox.querySelector('.btn-save');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'å„²å­˜ä¸­...';
            
            try {
              const response = await fetch('/api/update-checkbox', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  recordId: shipment.id,
                  checkboxUpdates: checkboxUpdates,
                }),
              });
              
              const result = await response.json();
              
              if (!response.ok || !result.success) {
                throw new Error(result.message || 'æ›´æ–°å¤±æ•—');
              }
              
              // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
              saveBtn.textContent = 'âœ“ å·²å„²å­˜';
              saveBtn.style.background = '#4caf50';
              
              setTimeout(() => {
                closeLightbox();
                // é‡æ–°è¼‰å…¥åˆ—è¡¨ä»¥åæ˜ è®Šæ›´ï¼ˆå¼·åˆ¶é‡æ–°ç²å–è³‡æ–™ï¼Œä¸ä½¿ç”¨å¿«å–ï¼‰
                fetchShipmentsList(true);
              }, 1000);
              
            } catch (error) {
              console.error('âŒ å„²å­˜å¤±æ•—:', error);
              saveBtn.textContent = 'âœ— å„²å­˜å¤±æ•—';
              saveBtn.style.background = '#f44336';
              setTimeout(() => {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                saveBtn.style.background = '#0D23A0';
              }, 2000);
            }
          }

          // åˆå§‹åŒ–
          refreshBtn.addEventListener('click', fetchShipmentsList);
          fetchShipmentsList();

